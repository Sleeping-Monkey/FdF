#include "fdf.h"

t_mat4           *m4_mul(t_mat4 *a, t_mat4 *b, t_mat4 *out)
{
    int r;
    int c;
    int i;

    if (!a || !b)
        return (NULL);
    if ((!out && !(out = NEW(t_mat4))) || a == out || b == out)
        return (NULL);
    r = 4;
    while (r--)
    {
        c = 4;
        while (c--)
        {
            i = 4;
            while (i--)
            {
                if (a->r[r][i])
                    out->r[r][c] += a->r[r][i] * b->r[i][c];
            }
        }
    }
    return (out);
}

t_vec4          *m4v4_mul(t_mat4 *a, t_vec4 *b, t_vec4 *out)
{
    int r;
    int c;

    if (!a || !b)
        return (NULL);
    if ((!out && !(out = NEW(t_vec4))) || b == out)
        return (NULL);
    r = 4;
    while (r--)
    {
        c = 4;
        while (c--)
        {
            if (a->r[r][c])
                out->v[c] += a->r[r][c] * b->v[r];
        }
    }
    return (out);
}

/* TODO: implement this https://www.sanfoundry.com/c-program-find-inverse-matrix/ ?*/
t_mat4          *m4_inv(t_mat4 *m, t_mat4 *out)
{
	t_real	det;
	t_real  a[4][4][4][4];
	if ((!out && !(out = NEW(t_mat4))))
		return (NULL);
	a[2][3][1][2] = m->r[1][2] * m->r[2][3] - m->r[1][3] * m->r[2][2];
	a[2][3][1][3] = m->r[1][2] * m->r[3][3] - m->r[1][3] * m->r[3][2];
	a[2][3][2][3] = m->r[2][2] * m->r[3][3] - m->r[2][3] * m->r[3][2];
	a[1][3][2][3] = m->r[2][1] * m->r[3][3] - m->r[2][3] * m->r[3][1];
	a[1][3][1][3] = m->r[1][1] * m->r[3][3] - m->r[1][3] * m->r[3][1];
	a[1][3][1][2] = m->r[1][1] * m->r[2][3] - m->r[1][3] * m->r[2][1];
	a[1][2][2][3] = m->r[2][1] * m->r[3][2] - m->r[2][2] * m->r[3][1];
	a[1][2][1][3] = m->r[1][1] * m->r[3][2] - m->r[1][2] * m->r[3][1];
	a[1][2][1][2] = m->r[1][1] * m->r[2][2] - m->r[1][2] * m->r[2][1];
	a[0][3][2][3] = m->r[2][0] * m->r[3][3] - m->r[2][3] * m->r[3][0];
	a[0][2][2][3] = m->r[2][0] * m->r[3][2] - m->r[2][2] * m->r[3][0];
	a[0][1][2][3] = m->r[2][0] * m->r[3][1] - m->r[2][1] * m->r[3][0];
	a[0][3][1][3] = m->r[1][0] * m->r[3][3] - m->r[1][3] * m->r[3][0];
	a[0][2][1][3] = m->r[1][0] * m->r[3][2] - m->r[1][2] * m->r[3][0];
	a[0][3][1][2] = m->r[1][0] * m->r[2][3] - m->r[1][3] * m->r[2][0];
	a[0][2][1][2] = m->r[1][0] * m->r[2][2] - m->r[1][2] * m->r[2][0];
	a[0][1][1][3] = m->r[1][0] * m->r[3][1] - m->r[1][1] * m->r[3][0];
	a[0][1][1][2] = m->r[1][0] * m->r[2][1] - m->r[1][1] * m->r[2][0];
	det = m->r[0][0] * ( m->r[1][1] * a[2][3][2][3] - m->r[1][2] * a[1][3][2][3] + m->r[1][3] * a[1][2][2][3] )
		- m->r[0][1] * ( m->r[1][0] * a[2][3][2][3] - m->r[1][2] * a[0][3][2][3] + m->r[1][3] * a[0][2][2][3] )
		+ m->r[0][2] * ( m->r[1][0] * a[1][3][2][3] - m->r[1][1] * a[0][3][2][3] + m->r[1][3] * a[0][1][2][3] )
		- m->r[0][3] * ( m->r[1][0] * a[1][2][2][3] - m->r[1][1] * a[0][2][2][3] + m->r[1][2] * a[0][1][2][3] );
	if (det == 0)
		return (NULL);
	det = 1 / det;
	out->r[0][0] = det *   ( m->r[1][1] * a[2][3][2][3] - m->r[1][2] * a[1][3][2][3] + m->r[1][3] * a[1][2][2][3] );
	out->r[0][1] = det * - ( m->r[0][1] * a[2][3][2][3] - m->r[0][2] * a[1][3][2][3] + m->r[0][3] * a[1][2][2][3] );
	out->r[0][2] = det *   ( m->r[0][1] * a[2][3][1][3] - m->r[0][2] * a[1][3][1][3] + m->r[0][3] * a[1][2][1][3] );
	out->r[0][3] = det * - ( m->r[0][1] * a[2][3][1][2] - m->r[0][2] * a[1][3][1][2] + m->r[0][3] * a[1][2][1][2] );
	out->r[1][0] = det * - ( m->r[1][0] * a[2][3][2][3] - m->r[1][2] * a[0][3][2][3] + m->r[1][3] * a[0][2][2][3] );
	out->r[1][1] = det *   ( m->r[0][0] * a[2][3][2][3] - m->r[0][2] * a[0][3][2][3] + m->r[0][3] * a[0][2][2][3] );
	out->r[1][2] = det * - ( m->r[0][0] * a[2][3][1][3] - m->r[0][2] * a[0][3][1][3] + m->r[0][3] * a[0][2][1][3] );
	out->r[1][3] = det *   ( m->r[0][0] * a[2][3][1][2] - m->r[0][2] * a[0][3][1][2] + m->r[0][3] * a[0][2][1][2] );
	out->r[2][0] = det *   ( m->r[1][0] * a[1][3][2][3] - m->r[1][1] * a[0][3][2][3] + m->r[1][3] * a[0][1][2][3] );
	out->r[2][1] = det * - ( m->r[0][0] * a[1][3][2][3] - m->r[0][1] * a[0][3][2][3] + m->r[0][3] * a[0][1][2][3] );
	out->r[2][2] = det *   ( m->r[0][0] * a[1][3][1][3] - m->r[0][1] * a[0][3][1][3] + m->r[0][3] * a[0][1][1][3] );
	out->r[2][3] = det * - ( m->r[0][0] * a[1][3][1][2] - m->r[0][1] * a[0][3][1][2] + m->r[0][3] * a[0][1][1][2] );
	out->r[3][0] = det * - ( m->r[1][0] * a[1][2][2][3] - m->r[1][1] * a[0][2][2][3] + m->r[1][2] * a[0][1][2][3] );
	out->r[3][1] = det *   ( m->r[0][0] * a[1][2][2][3] - m->r[0][1] * a[0][2][2][3] + m->r[0][2] * a[0][1][2][3] );
	out->r[3][2] = det * - ( m->r[0][0] * a[1][2][1][3] - m->r[0][1] * a[0][2][1][3] + m->r[0][2] * a[0][1][1][3] );
	out->r[3][3] = det *   ( m->r[0][0] * a[1][2][1][2] - m->r[0][1] * a[0][2][1][2] + m->r[0][2] * a[0][1][1][2] );
	return (out);
}
